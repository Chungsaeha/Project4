<template>
  <obg-button :icon="icon" ref="origin" :type="btnType">
    <slot name="icon"></slot>
    <obg-popover
      ref="popover"
      anchor="top middle"
      self="bottom right"
      class="context-menu"
      :style="{ height: contextMenuHeight + 'px' }"
      @open="showDimScreen"
      @close="hideDimScreen"
    >
      <div
        class="menu-item"
        v-for="(item, index) in options"
        :name="item.name"
        @click="onItemClick"
        v-obg-focus="{zone: 1, order: index + 1}"
      >
        <span class="item-content">
          {{item.label}}
        </span>
      </div>
    </obg-popover>
    <div ref="dim" class="dim"></div>
    <button ref="closeButton" class="close-button animate-scale">
      <i class="obg-icon-close" />
    </button>
  </obg-button>
</template>

<script>
  /**
   * @class context-menu
   * @classdesc components/context-menu
   * @param {string} [anchor] top | center | bottom + left | middle | right
   * @param {string} [self] top | center | bottom + left | middle | right
   * @param {string} [maxHeight]
   * @param {boolean} [disable]
   * @param {slot} [slot]
   * @event {string} [input]
   *
   * @example
   * import popover from 'obigo-js-ui/components/context-menu'
   * <obg-context-menu
   *  icon="more"
   *  :options="[{name: 'opt1', label: 'Option'}, {name: 'opt2', label: 'Advanced Setting'}, {name: 'opt3', label: 'Reset'}, {name: 'opt4', label: 'Help'}, {name: 'opt5', label: 'Smart Tutoriels'}]"
   * >
   * </obg-context-menu>
   */
  import popover from '../popover'
  import button from '../button'
  export default {
    props: {
      disable: Boolean,
      btnType: {
        type: String,
        default: 'round'
      },
      icon: {
        type: String,
        default: 'more'
      },
      options: {
        type: Array,
        required: true,
        validator (arr) {
          if (arr.length < 0 || arr.length > 5) {
            return false
          }
          arr.forEach((item) => {
            if (!(item.hasOwnProperty('name') && item.hasOwnProperty('label'))) {
              throw new Error('options should be [{ name: xxxx, label: yyyy}, ...]')
            }
          })
          return true
        }
      }
    },
    components: {
      'obg-button': button,
      'obg-popover': popover
    },
    computed: {
      contextMenuHeight () {
        return this.options.length * 68 + this.options.length - 3
      }
    },
    methods: {
      close () {
        this.$refs.popover.close()
      },
      __open (event) {
        if (!this.disable) {
          this.$refs.popover.open(event)
        }
      },
      onItemClick (e) {
        let name = e.currentTarget.getAttribute('name')
        this.$emit('input', name)
        this.close()
      },
      showDimScreen () {
        document.body.appendChild(this.$dim)
        document.body.appendChild(this.$closeButton)
        this.$dim.addEventListener('click', this.close)
        this.$closeButton.addEventListener('click', this.close)
        this.$emit('open')
      },
      hideDimScreen () {
        this.$dim.removeEventListener('click', this.close)
        this.$closeButton.removeEventListener('click', this.close)
        this.$focus.removeFocus()
        this.$emit('close')
        document.body.removeChild(this.$dim)
        document.body.removeChild(this.$closeButton)
      }
    },
    mounted () {
      const originPos = this.$refs.origin.$el.getBoundingClientRect()

      this.target = this.$refs.popover.$el.parentNode
      this.target.addEventListener('contextmenu', this.__open)
      this.$dim = this.$refs.dim
      this.$closeButton = this.$refs.closeButton
      this.$closeButton.style.top = (originPos.top + originPos.height / 2 - this.$refs.closeButton.offsetHeight / 2) + 'px'
      this.$closeButton.style.left = (originPos.left + originPos.width / 2 - this.$refs.closeButton.offsetWidth / 2) + 'px'

      this.$nextTick(() => {
        this.$el.childNodes[2].removeChild(this.$dim)
        this.$el.childNodes[2].removeChild(this.$closeButton)
      })
    },
    beforeDestroy () {
      this.target.removeEventListener('contexmenu', this.handler)
    }
  }
</script>
<style lang="scss" scoped>
  @import '../../styles/colors.variables.scss';
  div.context-menu{
    width: 355px;
    height: 343px;
    border: 1px solid $light-blue-9;
    overflow-y: hidden !important;
    margin-top: 36px;
    > div.menu-item {
      height:68px;
      color:color(white);
      font-size:32px;
      text-indent:20px;
      display: flex;
      align-items: center;
      background: color(black);

      &:last-child{
        &:after{
          width:355px;
        }
      }
      &:after{
        content: '';
        width: 339px;
        height: 1px;
        border-bottom: 1px solid #3a3c3d;
        position: absolute;
        margin-top: 34px;
        margin-left: 9px;
      }
      &:active{
        background: color(secondary);
      }
      &.obg-focus{
        &:before{
          position: absolute;
          height: 63px;
          width: 347px;
          content: '';
          border: 3px solid #fff;
          margin-top: 0px;
          margin-left: 0px;
        }
        &:after{
          border-color:color(white)
        }
      }
    }
  }
  .dim{
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 160;
    background: rgba(0, 0, 0, 0.7);
  }
  .close-button{
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: color(dark);
    height: 69px;
    width: 69px;
    border-radius: 35px;
    z-index: 200;
    &:active{
      background: color(secondary);
    }
    & > div{
      &:before, &:after{
        content: '';
        border: 2px solid white;
        display: block;
        position: relative;
        transform: rotate(45deg);
      }
      &:before{
        height: 30px;
        float: left;
        margin-left: 15px;
        margin-top: -3px;
        transform: rotate(45deg);
      }
      &:after{
        content: '';
        top: 12px;
        left: 1px;
        width: 30px;
      }
    }
  }
  .animate-scale {
    animation: popover-scale .2s;
  }

  @keyframes popover-scale {
    0% {
      opacity: 0;
      transform: scale(0.7)
    }
    100% {
      opacity: 1;
      transform: scale(1)
    }
  }
</style>
