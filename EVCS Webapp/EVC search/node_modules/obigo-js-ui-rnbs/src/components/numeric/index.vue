<template>
  <div
    class="obg-numeric"
    :style="{ width: width + 'px', height: height + 'px' }"
    :delimiter="delimiter"
  >
    <button
      ref="up"
      class="obg-numeric-button up"
      :style="{ width: width + 'px', height: (height/2) + 'px' }"
      @click="valueUp"
    />
    <div
      ref="number"
      class="number"
      :style="{ width: width + 'px', top: numberTop +'px' }"
    >
      {{padDigits}}
      </div>
    <button
      ref="down"
      class="obg-numeric-button down"
      :style="{ width: width + 'px', height: (height/2) + 'px' }"
      @click="valueDown"
    />
    <div
      class="delimiter"
      ref="delimiter"
      v-show="showDelimiter"
      :style="{ top: delimiterTop +'px', left: delimiterLeft + 'px' }"
    >
      {{delimiter}}
      </div>
  </div>
</template>

<script>
  import longpress from '../../features/longPress'

  export default {
    name: 'obg-numeric',
    components: {
    },
    props: {
      min: {
        type: Number,
        default: 0
      },
      max: {
        type: Number,
        default: 99
      },
      step: {
        type: Number,
        default: 1
      },
      disabled: {
        type: Boolean,
        default: false
      },
      value: {
        type: Number,
        default: 0
      },
      width: {
        type: Number,
        default: 150
      },
      height: {
        type: Number,
        default: 300
      },
      delimiter: {
        type: String,
        default: ':'
      },
      showDelimiter: {
        type: Boolean,
        default: true
      },
      placeValue: {
        type: Number,
        default: 2
      }
    },
    computed: {
      numberTop () {
        return -(this.numberHeight / 2)
      },
      delimiterTop () {
        return -(this.height / 2) + -(this.delimiterHeight / 2)
      },
      delimiterLeft () {
        return this.width - this.delimiterWidth / 2
      },
      padDigits () {
        return Array(Math.max(this.placeValue - String(this.digits).length + 1, 0)).join(0) + this.digits
      }
    },
    watch: {
      value (val) {
        if (val < this.min || val > this.max) return
        this.digits = val
      }
    },
    mounted () {
      const up = this.$refs.up
      const down = this.$refs.down
      longpress(up, {
        counter: () => {
          this.valueUp()
        },
        end: () => {
          this.onInput(this.digits)
        }
      })
      longpress(down, {
        counter: () => {
          this.valueDown()
        },
        end: () => {
          this.onInput(this.digits)
        }
      })
      this.$on('jogclick', () => {
        this.focus = !(this.focus)
        if (this.focus) {
          // TODO add jog event listner - value up/down
        } else {
          // TODO remove jog event
        }
      })
      this.$on('focusout', () => {
        this.focus = false
      })
      this.$nextTick(() => {
        let elementOffset = this.$el.getClientRects()[0]
        let numberOffset = this.$refs.number.getClientRects()[0]
        this.offsetTop = elementOffset.top
        this.offsetLeft = elementOffset.left
        this.numberHeight = numberOffset.height
        if (this.showDelimiter) {
          let delimiterOffset = this.$refs.delimiter.getClientRects()[0]
          this.delimiterHeight = delimiterOffset.height
          this.delimiterWidth = delimiterOffset.width
          this.$refs.delimiter.style.height = '0px'
        }
        this.$refs.number.style.height = '0px'
      })
    },
    data () {
      return {
        digits: (this.value < this.min) ? this.min : this.value,
        focus: false,
        offsetTop: 0,
        numberHeight: 0,
        delimiterOffsetTop: 0,
        delimiterWidth: 1,
        delimiterHeight: 1
      }
    },
    methods: {
      valueDown () {
        this.digits = this.digits - this.step
        if (this.digits < this.min) this.digits = this.min
        this.$emit('input', this.digits)
      },
      valueUp () {
        this.digits = this.digits + this.step
        if (this.digits > this.max) this.digits = this.max
        this.$emit('input', this.digits)
      },
      onInput (val) {
        this.$emit('input', val)
      }
    }
  }
</script>
<style lang='scss' scoped>
  @import '../../styles/colors.variables.scss';
  .obg-numeric {
    display: inline-block;
    & > .number{
      position: relative;
      font-size: 4em;
      text-align: center;
      color: color(white);
      display: block;
    }
    & > .obg-numeric-button{
      display: block;
      border: 2px solid color(black);
      box-shadow: rgb(68, 68, 68) 0px 2px 0px inset;
      background-color: rgb(25, 25, 25);
      color: color(white);
      font-size: 30px;
      &:active{
        border-color: color(white);
        box-shadow: none;
        color: color(white);
        background-color: color(secondary);
      }
      &.up{
        border-bottom: 1px solid #232323;
        &:active{
          border-bottom-color: color(white);
          &:before{
            border-color: color(white);
          }
        }
        &:before{
          content: '';
          border: solid color(primary);
          border-width: 0 .2em .2em 0;
          display: inline-block;
          padding: .30em;
          transform: rotate(-135deg);
          vertical-align: top;
          margin-top: -1em;
        }
      }
      &.down{
        box-shadow: rgb(68, 68, 68) 0px -2px 0px inset;
        border-top: 1px solid #232323;
        &:active{
          border-top-color: color(white);
          &:before{
            border-color:color(white);
          }
        }
        &:before{
          content: '';
          border: solid color(primary);
          border-width: 0 .2em .2em 0;
          display: inline-block;
          padding: .30em;
          transform: rotate(45deg);
          vertical-align: bottom;
          margin-bottom: -1em;
        }
      }
    }
    & > .delimiter{
      position:relative;
      font-size: 4em;
      color: #7b7b7b;
      display:inline-block;
    }
  }
</style>
