<template>
  <div
    class="obg-tab"
    :class="[{
      'is-animated': animated
    }]"
  >
    <div class="divider" />
    <div
      class="slide-factor"
      ref="slideFactor"
      v-if="animated"
    ></div>
    <slot></slot>
    <div class="divider" />
  </div>
</template>

<script>
  /**
   * @class tab
   * @classdesc components/tab
   * @param {slot} [slot] tab-item
   * @param {boolean} [animated=true]
   *
   * @example
   * import {Tab,TabItem} from 'obigo-js-ui/components/tab'
   * <obg-tab v-model="btnGroup" :animated=true :value=2>
   *    <obg-tab-item>A</obg-tab-item>
   *    <obg-tab-item selected>B</obg-tab-item>
   *    <obg-tab-item>C</obg-tab-item>
   * </obg-tab>
   */
  import { parentMixin } from '../../mixins/multi-items'
  import TWEEN from 'tween.js'

  export default {
    name: 'obg-tab',
    mixins: [parentMixin],
    data () {
      return {
      }
    },
    props: {
      animated: {
        type: Boolean,
        default: true
      }
    },
    watch: {
      currentIndex (val) {
        if (this.animated) {
          var startValue
          this.slidePosition = this.currentIndex * this.tweeningWidth
          if (this.previousIndex >= 0) {
            startValue = this.previousIndex * this.tweeningWidth
            this.tween(startValue, this.slidePosition, this.$slideFactor, 300)
          } else {
            this.tween(0, this.slidePosition, this.$slideFactor, 0)
          }
        }
      }
    },
    mounted () {
      if (this.$children.length < 2 || this.$children.length > 4) {
        throw new Error('Count of tab-item is ' + this.$children.length + '\n Number of tab-item should be 2~4')
      }
      this.clientWidth = this.$el.clientWidth
      this.tweeningWidth = this.$children[1].$el.offsetWidth
      this.$slideFactor = this.$refs.slideFactor
      this.$slideFactor.style.width = this.tweeningWidth + 'px'
//      let items = this.$slots.default.filter(function (item) { return (item.tag) })
//      this.itemCount = items.length
    },
    updated () {
      this.$nextTick(() => {
        if (this.$children.length > 1) {
          this.tweeningWidth = this.$children[1].$el.offsetWidth
          this.$slideFactor.style.width = this.tweeningWidth + 'px'
          this.$slideFactor.style.transform = 'translateX(' + (this.currentIndex * this.tweeningWidth) + 'px)'
        }
      })
    },
    methods: {
      tween: function (startValue, endValue, el, duration) {
        var _el = el
        var animationFrame
        function animate (time) {
          TWEEN.update(time)
          animationFrame = requestAnimationFrame(animate)
        }
        new TWEEN.Tween({left: startValue})
          .to({ left: endValue }, duration)
          .onUpdate(function () {
            _el.style.transform = 'translateX(' + this.left + 'px)'
            _el.style.webkitTransform = 'translateX(' + this.left + 'px)'
          })
          .onComplete(function () {
            cancelAnimationFrame(animationFrame)
          })
          .start()
        animationFrame = requestAnimationFrame(animate)
      }
    }
  }
</script>

<style lang="scss" scoped>
  @import '../../styles/colors.variables.scss';
  .obg-tab{
    display: flex;
    position: relative;
    width: 546px;
    background: color(tertiary);
    & > a{
      text-decoration:none;
    }
    &.is-animated > a.obg-tab-current{
      background:none;
      &:active{
        background: color(secondary);
      }
    }
    .slide-factor{
      position: absolute;
      height: 78px;
      background-color: color(tertiary);
      border-bottom: 5px solid color(primary);
      left:-1px;
      &:active{
        background: color(secondary);
      }
    }
    & > .divider{
      position:absolute;
      content:"";
      margin-top: 23px;
      margin-left: 0px;
      width: 1px;
      height: 25px;
      background-color: $grey-7;
      z-index: 1;
      &:last-child{
        margin-left:-1px;
      }
    }
  }

</style>
